/**
 * @file firestore.rules
 * @description Security rules for a game application with an admin panel.
 *
 * @section Core Philosophy
 * This ruleset implements a Role-Based Access Control (RBAC) model. A user's
 * administrative status is the primary factor for granting elevated permissions.
 * Standard users have limited access, primarily to manage their own data.
 *
 * @section Data Structure
 * - /users/{userId}: Stores private user profile data. Each user has exclusive
 *   control over their own document.
 * - /users/{userId}/activities/{activityId}: Subcollection for user-specific events.
 * - /roles_admin/{userId}: A dedicated collection for managing admin privileges. The
 *   mere existence of a document here grants a user admin rights across the app.
 * - /game_levels/{gameLevelId}: Contains game configuration drafts. Only editable by admins.
 * - /published_game_levels/{gameLevelId}: Contains the live game levels. Readable by all, but only writable via admin "publish" action (handled server-side/batch).
 * - /settings/admin: A singleton document for global app settings, only writable by admins.
 * - /settings/game_assets: A singleton for custom game image URLs. Writable by admins, readable by all.
 * - /game_events/{eventId}: Stores analytics data for game sessions. Writable by any signed-in user, readable only by admins.
 * - /leaderboard/{entryId}: Stores public leaderboard scores. Writable by users for their own scores, readable by all.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the given userId.
     * This is the foundation for document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for the existence of a document in the roles_admin collection.
     * This is the single source of truth for determining admin privileges.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    // -------------------------------------------------------------------------
    // User Profiles & Activities (/users)
    // -------------------------------------------------------------------------

    match /users/{userId} {
      /**
       * @description Controls access to user profile documents.
       * @path /users/{userId}
       * @allow (read, create) A user can create and read their own profile.
       * @allow (update) A user can update their own highScore or displayName.
       * @deny A user cannot access another user's profile.
       */
      allow read, create: if isOwner(userId);
      allow update: if isOwner(userId) && (
          (request.resource.data.highScore >= resource.data.highScore && request.resource.data.displayName == resource.data.displayName) || 
          (request.resource.data.displayName != resource.data.displayName && request.resource.data.highScore == resource.data.highScore)
      );
      allow list, delete: if false;

      /**
       * @description Controls access to a user's activity log.
       * @path /users/{userId}/activities/{activityId}
       * @allow A user can create and read their own activities.
       * @deny A user cannot update, delete, or list their activities to maintain integrity.
       * @deny A user cannot access another user's activities.
       */
      match /activities/{activityId} {
        allow create, read: if isOwner(userId);
        allow update, delete, list: if false;
      }
    }
    
    // -------------------------------------------------------------------------
    // Leaderboard (/leaderboard)
    // -------------------------------------------------------------------------
    
    /**
     * @description Controls access to the global leaderboard.
     * @path /leaderboard/{entryId}
     * @allow (read) Anyone can read the leaderboard scores.
     * @allow (create) A signed-in user can create a score only for themselves.
     * @deny Updates and deletes are forbidden from the client to prevent tampering.
     */
    match /leaderboard/{entryId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // -------------------------------------------------------------------------
    // Admin Roles (/roles_admin)
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to the admin role lookup collection.
     * @path /roles_admin/{userId}
     * @allow (get) Any signed-in user can check their own admin status.
     * @allow (list) Admins can list all admin roles.
     * @deny All client-side writes are forbidden to prevent privilege escalation.
     */
    match /roles_admin/{userId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow write: if false; // CRITICAL: Prevent client-side privilege escalation.
    }

    // -------------------------------------------------------------------------
    // Game Levels (/game_levels - DRAFTS)
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to DRAFT game level configurations.
     * @path /game_levels/{gameLevelId}
     * @allow (read, write) Only admins can manage draft game levels.
     */
    match /game_levels/{gameLevelId} {
      allow read, write: if isAdmin();
    }
    
    // -------------------------------------------------------------------------
    // Published Game Levels (/published_game_levels - LIVE)
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to the PUBLISHED game level configurations.
     * @path /published_game_levels/{gameLevelId}
     * @allow (read) Any user can read the live game levels.
     * @deny Client-side writes are forbidden. Publishing is handled by a batch write.
     */
    match /published_game_levels/{gameLevelId} {
        allow get, list: if true;
        allow write: if false; // CRITICAL: Prevent direct client-side edits to live levels.
    }
    
    // -------------------------------------------------------------------------
    // Analytics (/game_events)
    // -------------------------------------------------------------------------
    
    /**
     * @description Controls access to the analytics game events.
     * @path /game_events/{eventId}
     * @allow (write) Any signed-in user can create a game event.
     * @allow (read, list) Only admins can read the analytics data.
     * @deny Updates and deletes are not allowed to ensure data integrity.
     */
    match /game_events/{eventId} {
      allow write: if isSignedIn();
      allow read, list: if isAdmin();
      allow update, delete: if false;
    }

    // -------------------------------------------------------------------------
    // Admin Settings (/settings)
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to the global admin settings.
     * @path /settings/admin
     * @allow (read) Any signed-in user can read the settings.
     * @allow (write) Only admins can change the settings.
     */
    match /settings/admin {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }

    /**
     * @description Controls access to the custom game assets.
     * @path /settings/game_assets
     * @allow (read) Any user can read the asset URLs.
     * @allow (write) Any signed-in user can change the asset URLs from the admin page.
     */
    match /settings/game_assets {
        allow read: if true;
        allow write: if isSignedIn();
    }
  }
}
